ACMS.Dispatch.Admin=function(_context){const context=_context instanceof jQuery?_context.find("*").get(0):_context;if(!context){return}var Admin=arguments.callee;if(typeof Config==="undefined"){var Config=ACMS.Config}$("input#checkAll",context).on("change",function(){$('input[type=checkbox][name="checks[]"]:not(:disabled):visible').prop("checked",this.checked)});ACMS.Dispatch.Utility.unloadAlert(context);$(".js-incremental_search",context).each(function(){Admin.acmsIncrementalSearch(this,$(".js-incremental_search_box",context))});Admin.acmsTabs(context);$(".js-acms-tab-select",context).each(function(){Admin.acmsSelectTabs(this)});$(".js-acms-dropdown-toggle:not(.js-acms-dropdown-toggle-hover)",context).each(function(){Admin.acmsDropdown(this)});$(".js-acms-dropdown-toggle.js-acms-dropdown-toggle-hover",context).each(function(){Admin.acmsDropdownHover(this)});$("table#js-arg_reference .js-arg_reference_trigger",context).click(function(){var self=arguments.callee,$trigger=$(this),bid=ACMS.Config.bid,field=$trigger.attr("name"),url;if(field==="session_uid"){field="uid"}if($trigger.attr("data-bid")){bid=$trigger.attr("data-bid")}if(1&field!="bid"&field!="cid"&field!="ccd"&field!="eid"&field!="uid"&field!="ucd"){return false}$().dialog();$trigger.attr("disabled","disabled");if("undefined"==typeof self.$popup){self.$popup={}}if(_.contains(["bid","uid","cid","eid"],field)){url="ajax/arg/"+field+"-reference.html"}else{url="ajax/arg/reference.html"}if(0===$("#reference-"+field,context).length){var url=ACMS.Library.acmsLink({bid:bid,tpl:url,Query:{scope:field,hash:Math.random().toString()}},false);$.get(url,function(html){var code='                    <div class="acms-admin-modal out">                      <div class="acms-admin-modal-dialog" role="dialog" aria-modal aria-labelledby="acms-admin-arg-reference-title">                        <div class="acms-admin-modal-content">                            <header class="acms-admin-modal-header">                              <h1 id="acms-admin-arg-reference-title" class="acms-admin-modal-heading">ID参照</h1>                              <button type="button" class="acms-admin-modal-hide" aria-label="ID参照を閉じる">                                <span class="acms-admin-icon-delete" aria-hidden="true"></span>                              </button>                            </header>                            <div class="acms-admin-modal-body">                                <div class="acms-admin-margin-top-small js-modal_content clearfix"></div>                            </div>                        </div>                      </div>                    </div>';var $backdrop=$($.parseHTML('<div class="acms-admin-modal-backdrop"></div>')).hide().appendTo("body"),$modalBox=$($.parseHTML(code)).appendTo("body"),$raw=$($.parseHTML(html)),$input=$trigger.closest(".js-arg_guidance").find(".js-arg_guidance_edit"),$labelBox=$trigger.closest(".js-arg_guidance").find(".js-arg_guidance_label"),$labelDummy=$(".js-arg_reference_dummy");if($modalBox.length){$("body").css("overflow","hidden");$modalBox.find(".js-modal_content").append($raw);setTimeout(function(){$modalBox.show();$backdrop.show();$modalBox.removeClass("out").delay(200).queue(function(){$(this).addClass("in").delay(500).queue(function(){$(this).addClass("display").removeClass("in")}).dequeue()});Admin($modalBox);ACMS.dispatchEvent("acmsDialogOpened",$modalBox.get(1),{item:$modalBox.get(1)})},200)}$form=$modalBox.find(".js-ajax_load");$form.on("submit",async function(event){event.preventDefault();const formData=new FormData(event.target,event.originalEvent.submitter);const response=await fetch(window.location.href,{method:"POST",body:formData,headers:{"X-CSRF-Token":window.csrfToken,"X-Requested-With":"XMLHttpRequest"}});if(!response.ok){throw new Error("Failed to fetch reference")}const html=await response.text();$modalBox.find(".js-ajax_load_replace").html(html)});$(".js-ajax_load_link_delegate",$modalBox).on("click",".js-ajax_load_link a",function(){var href=$(this).attr("href");var query=href.split("?")[1];var send=ACMS.Library.getParameterByName("send","?"+query);if(!send){if(!!query){href+="&send=ajax"}else{href+="?send=ajax"}}$.get(href,function(html){$modalBox.find(".js-ajax_load_replace").html(html)});event.preventDefault();return false});var closeFn=function(){$("body").css("overflow","");$backdrop.fadeOut(150,function(){$backdrop.remove()});$modalBox.removeClass("display").addClass("out");setTimeout(function(){$modalBox.remove()},500);return false};$(".acms-admin-modal-hide").bind("click",closeFn);$modalBox.click(function(event){var click=event.target;if($(click).hasClass("acms-admin-modal")){closeFn()}});$(".js-ajax_load_link_delegate",$modalBox).on("click",".js-arg_reference_anchor",function(){var $label=$labelDummy.clone().show().css("display","inline-block"),ids=$input.val().split(","),id=String($(this).data("id")),label=$(this).data("label");if(!_.include(ids,id)){$label.find("span").text(label);$label.attr("data-arg",id);Admin.argReferenceRemove($label);if($input.data("multi")==="on"){$labelBox.append($label[0]);$labelBox.append(" ");if(id)ids.push(id)}else{$labelBox.html($label[0]);if(id)ids=Array(id)}ids=_.uniq(ids);ids=$.grep(ids,function(e){return e});$input.val(ids.join())}closeFn();return false})})}$trigger.removeAttr("disabled");return false});$(".js-arg_reference_remove",context).each(function(){Admin.argReferenceRemove(this)});$("#js-arg_guidance_name",context).each(function(){function setGuidance(module){if(module!==""){var guide=ACMS.Config.Admin.argGuidance[module];var axisGuide=ACMS.Config.Admin.axisGuidance[module];var multiArgs=ACMS.Config.Admin.multiArgGuidance[module];if(typeof guide!=="undefined"){$("input:text, input:checkbox, .js-arg_reference_trigger",$('[id^="js-arg_guidance_"]')).attr("disabled","disabled");$(".js-arg_reference_toggle",$('[id^="js-arg_guidance_"]')).hide();$('tr[id^="js-arg_guidance_"]').css("color","silver");$.each(guide,function(){$('[name^="'+this+'"]').removeAttr("disabled");$(".js-target_"+this).show();$("tr#js-arg_guidance_"+this).css("color","black")})}else{$("input:text, input:checkbox",$('[id^="js-arg_guidance_"]')).removeAttr("disabled");$('tr[id^="js-arg_guidance_"]').css("color","black")}if(typeof axisGuide!=="undefined"){$("input:text, input:checkbox, select",$('[id^="js-axis_guidance_"]')).attr("disabled","disabled");$('tr[id^="js-axis_guidance_"]').css("color","silver");$.each(axisGuide,function(){$('[name^="'+this+'"]').removeAttr("disabled");$("tr#js-axis_guidance_"+this).css("color","black")})}else{$("input:text, input:checkbox, select",$('[id^="js-axis_guidance_"]')).removeAttr("disabled");$('tr[id^="js-axis_guidance_"]').css("color","black")}$("input:text",$('[id^="js-arg_guidance_"]')).removeAttr("data-multi");$(".js-arg_guidance_multi_icon",$('[id^="js-arg_guidance_"]')).attr("style","display:none !important");if(typeof multiArgs!=="undefined"){$.each(multiArgs,function(){$(".js-arg_guidance_multi_icon_"+this).attr("style","display: inline-block !important");$('input:text[name^="'+this+'"]').attr("data-multi","on")})}}}$(this).on("change",function(){var module=$(this).val();setGuidance(module)});var module=$(this).val();setGuidance(module)});$(".js-arg_reference_toggle ~ .argEdit",context).hide();$(".js-arg_reference_toggle",context).click(function(){var $item=$(this).closest(".js-arg_guidance");var $text=$item.find(".argEdit");var $label=$item.find(".argLabel");$text.toggle();$label.toggle();return false});$(".switching-function-btn:not(:checked)",context).each(function(){$(this).closest("table").next("div").hide()});$(".switching-function-btn",context).click(function(){var box=$(this).closest("table").next("div");if($(this).prop("checked")===true){box.slideDown("fast")}else{box.slideUp("fast")}});$(".js-acms_entry_index_duplicate",context).click(function(){var $self=$(this);var $row=$self.parents("tr");var $id=$('[name^="checks"]',$row).val();var $form=document.createElement("form");var $checks=document.createElement("input");var $submit=document.createElement("input");var $token=document.createElement("input");$checks.name="checks[]";$checks.value=$id;$checks.type="hidden";$submit.name="ACMS_POST_Entry_Index_Duplicate";$submit.value="duplicate";$submit.type="hidden";$token.name="formToken";$token.type="hidden";$token.value=window.csrfToken;$form.method="post";$form.appendChild($checks);$form.appendChild($submit);$form.appendChild($token);document.body.appendChild($form);$form.submit();return false});$(".js-acms_entry_index_delete",context).on("click",function(){if(confirm(ACMS.i18n("edit.message1"))){var $self=$(this);var $row=$self.parents("tr");var $id=$('[name^="checks"]',$row).val().split(":")[1];var $form=document.createElement("form");var $checks=document.createElement("input");var $submit=document.createElement("input");var $token=document.createElement("input");$checks.name="eid";$checks.value=$id;$checks.type="hidden";$submit.name="ACMS_POST_Entry_Trash";$submit.value="delete";$submit.type="hidden";$token.name="formToken";$token.type="hidden";$token.value=window.csrfToken;$form.method="post";$form.appendChild($checks);$form.appendChild($submit);$form.appendChild($token);document.body.appendChild($form);$form.submit()}return false});$(".js-acms_entry_index_trash",context).on("click",function(){if(confirm(ACMS.i18n("edit.message2"))){var $self=$(this);var $row=$self.parents("tr");var $id=$('[name^="checks"]',$row).val().split(":")[1];var $form=document.createElement("form");var $checks=document.createElement("input");var $submit=document.createElement("input");var $token=document.createElement("input");$checks.name="eid";$checks.value=$id;$checks.type="hidden";$submit.name="ACMS_POST_Entry_TrashRestore";$submit.value="restore";$submit.type="hidden";$token.name="formToken";$token.type="hidden";$token.value=window.csrfToken;$form.method="post";$form.appendChild($checks);$form.appendChild($submit);$form.appendChild($token);document.body.appendChild($form);$form.submit()}return false});if($(".js-acms_fix_marker",context).length){const $marker=$(".js-acms_fix_marker",context);if(!$marker.hasClass("js-acms-pretty-fixed")){$marker.width();$marker.addClass("js-acms-pretty-fixed");$marker.each(function(){$(this).parent(".acms-admin-float-right").width($(this).width());new ACMS.Library.PrettyScroll($(this).get(0),{offsetTop:0})})}}$(Config.adminTableSortableMark,context).each(function(){ACMS.Dispatch.Admin.adminTableSortable(this)})};ACMS.Dispatch.Admin.acmsIncrementalSearch=function(elm,$input){var $item=$(".search_element",elm),placeholder=$input.attr("placeholder");$input.keyup(function(){var search=this.value.split(" ");if(0||search.length===1&&search[0]===placeholder||search.length===2&&search[0]+" "+search[1]===placeholder){return false}for(var i=0;i<$item.length;i++){var $clone=$($item[i]).clone(false);$clone.find(".except").remove();var itemName=$clone.text();if(itemName.match(new RegExp(search[0],"i"))||!search[0]){$($item[i]).show();if(search.length>1){for(var j=1;j<search.length;j++){if(!itemName.match(new RegExp(search[j],"i"))){$($item[i]).hide()}}}}else{$($item[i]).hide()}}return false}).keyup()};ACMS.Dispatch.Admin.acmsTabs=function(context){ACMS.Library.tab(".js-acms_admin_tabs",{enableHashNavigation:true,onShow:function({tab,panel}){ACMS.dispatchEvent("acmsAdminShowTabPanel",tab,{tab:tab,panel:panel})},onHide:function({tab,panel}){ACMS.dispatchEvent("acmsAdminHideTabPanel",tab,{tab:tab,panel:panel})}},context)};ACMS.Dispatch.Admin.acmsSelectTabs=function(elm){var $select=$(".js-acms-tab-select-value",elm);var $expr=$(".js-acms-tab-select-panel",elm);$select.change(function(){$expr.each(function(){$(this).removeClass("js-acms-tab-select-active")});var id="#"+$(this).val();$(id,elm).addClass("js-acms-tab-select-active");ACMS.dispatchEvent("acmsAdminSelectTab",elm)})};ACMS.Dispatch.Admin.acmsDropdown=function(elm){var $button=$(".js-acms-dropdown-btn",elm);var $menu=$(".js-acms-dropdown-menu",elm);var within=$menu.data("within");var my=$menu.data("pos-my");var at=$menu.data("pos-at");my=my?my:"left top";at=at?at:"left bottom+5";function initAccessibility(){$button.attr({"aria-haspopup":"true","aria-expanded":"false","aria-controls":$menu.attr("id")||"dropdown-menu-"+Math.random().toString(36).substring(2,10)});if(!$menu.attr("id")){$menu.attr("id",$button.attr("aria-controls"))}$menu.attr({role:"menu","aria-labelledby":$button.attr("id")||"dropdown-btn-"+Math.random().toString(36).substring(2,10)});if(!$button.attr("id")){$button.attr("id",$menu.attr("aria-labelledby"))}$menu.find("a, button").attr("role","menuitem").attr("tabindex","-1")}function openDropdown(){var position={of:$button[0],my:my,at:at};if(within){position.within=within}$(".js-acms-dropdown-menu",document).hide();$menu.show().position(position);$button.attr("aria-expanded","true");var $firstItem=$menu.find('[role="menuitem"]:visible:first');if($firstItem.length){$firstItem.attr("tabindex","0").focus()}}function closeDropdown(){$menu.hide();$button.attr("aria-expanded","false");$button.trigger("focus");$menu.find('[role="menuitem"]').attr("tabindex","-1")}function handleKeyboardNavigation(event){var $focusedItem=$menu.find('[role="menuitem"]:focus');var $allItems=$menu.find('[role="menuitem"]:visible');var currentIndex=$allItems.index($focusedItem);switch(event.keyCode){case 27:closeDropdown();event.preventDefault();break;case 38:if(currentIndex>0){$allItems.eq(currentIndex-1).attr("tabindex","0").trigger("focus");$focusedItem.attr("tabindex","-1")}event.preventDefault();break;case 40:if(currentIndex<$allItems.length-1){$allItems.eq(currentIndex+1).attr("tabindex","0").trigger("focus");$focusedItem.attr("tabindex","-1")}event.preventDefault();break;case 36:$allItems.first().attr("tabindex","0").trigger("focus");$focusedItem.attr("tabindex","-1");event.preventDefault();break;case 35:$allItems.last().attr("tabindex","0").trigger("focus");$focusedItem.attr("tabindex","-1");event.preventDefault();break}}initAccessibility();$button.off("click").on("click",function(){var $open=$menu.css("display");if($open==="block"){closeDropdown()}else{openDropdown()}$(document).off("click.dropdown");$(document).on("click.dropdown",function(){$(".js-acms-dropdown-menu",document).hide();$(document).off("click.dropdown")});return false});$button.on("keydown",function(event){switch(event.keyCode){case 13:case 32:event.preventDefault();$(this).trigger("click");break}});$menu.on("keydown",'[role="menuitem"]',handleKeyboardNavigation);$menu.on("click",'[role="menuitem"]',function(){closeDropdown()});$menu.on("focusout",function(event){if(!$(event.relatedTarget).closest($menu).length&&!$(event.relatedTarget).is($button)){closeDropdown()}})};ACMS.Dispatch.Admin.acmsDropdownHover=function(elm){var $button=$(".js-acms-dropdown-btn",elm);var $dropdown=$(".js-acms-dropdown-menu",elm);var within=$dropdown.data("within");var my=$dropdown.data("pos-my");var at=$dropdown.data("pos-at");my=my?my:"left top";at=at?at:"left bottom+5";function initAccessibility(){$button.attr({"aria-haspopup":"true","aria-expanded":"false","aria-controls":$dropdown.attr("id")||"dropdown-menu-"+Math.random().toString(36).substring(2,10)});if(!$dropdown.attr("id")){$dropdown.attr("id",$button.attr("aria-controls"))}$dropdown.attr({role:"menu","aria-labelledby":$button.attr("id")||"dropdown-btn-"+Math.random().toString(36).substring(2,10)});if(!$button.attr("id")){$button.attr("id",$dropdown.attr("aria-labelledby"))}$dropdown.find("a, button").attr("role","menuitem").attr("tabindex","-1")}function openDropdown(){var position={of:$button[0],my:my,at:at};if(within){position.within=within}$dropdown.show().position(position);$button.attr("aria-expanded","true")}function closeDropdown(){$dropdown.hide();$button.attr("aria-expanded","false")}function handleKeyboardNavigation(event){var $focusedItem=$dropdown.find('[role="menuitem"]:focus');var $allItems=$dropdown.find('[role="menuitem"]:visible');var currentIndex=$allItems.index($focusedItem);switch(event.keyCode){case 27:closeDropdown();$button.focus();event.preventDefault();break;case 38:if(currentIndex>0){$allItems.eq(currentIndex-1).attr("tabindex","0").trigger("focus");$focusedItem.attr("tabindex","-1")}event.preventDefault();break;case 40:if(currentIndex<$allItems.length-1){$allItems.eq(currentIndex+1).attr("tabindex","0").trigger("focus");$focusedItem.attr("tabindex","-1")}event.preventDefault();break;case 36:$allItems.first().attr("tabindex","0").trigger("focus");$focusedItem.attr("tabindex","-1");event.preventDefault();break;case 35:$allItems.last().attr("tabindex","0").trigger("focus");$focusedItem.attr("tabindex","-1");event.preventDefault();break}}initAccessibility();$button.off("mouseenter").on("mouseenter",function(){openDropdown()}).off("mouseleave").on("mouseleave",function(){$dropdown.data("timer",setTimeout(function(){closeDropdown()},100))});$dropdown.off("mouseover").on("mouseover",function(){if($(this).data("timer")){clearTimeout($(this).data("timer"))}});$dropdown.off("mouseleave").on("mouseleave",function(){closeDropdown()});$button.on("keydown",function(event){switch(event.keyCode){case 13:case 32:event.preventDefault();openDropdown();var $firstItem=$dropdown.find('[role="menuitem"]:visible:first');if($firstItem.length){$firstItem.attr("tabindex","0").focus()}break}});$dropdown.on("keydown",'[role="menuitem"]',handleKeyboardNavigation);$dropdown.on("click",'[role="menuitem"]',function(){closeDropdown();$button.trigger("focus")});$dropdown.on("focusout",function(event){if(!$(event.relatedTarget).closest($dropdown).length&&!$(event.relatedTarget).is($button)){closeDropdown()}})};ACMS.Dispatch.Admin.argReferenceRemove=function(elm){$(elm).click(function(){var $self=$(this);var $input=$self.closest(".js-arg_guidance").find(".argEdit");$self.fadeOut(function(){var arg=String($self.data("arg"));var ids=$input.val().split(",");ids=_.reject(ids,function(id){return id===arg});$input.val(ids.join());$(this).remove()});return false})};ACMS.Dispatch.Admin.adminTableSortable=function(elm){if($(elm).data("sort-enable")!=="on"){$(".item-handle",elm).hide();return false}else{$(".item-handle",elm).show()}var $adminTable=$("tbody",elm),$submitName=$(elm).data("sort-submit"),$targetForm=$(elm).parents("form");$entryOrder=$(elm).data("sort-order"),$isException=$(elm).hasClass("exceptionSort"),$firstSortNum=$("tbody > tr:first",elm).find(".sort-number").val(),$anchor=$(elm).find(".item-template"),$insert=$(elm).find(".item-insert"),$template=$anchor.clone(),$parentList=$(elm).find("[name^=navigation_parent]").eq(1).clone();$anchor.find(":input").attr("disabled","disabled");$anchor.hide();$insert.bind("click",function(){addItem()});$adminTable.sortable({activate:function(event,ui){var level=ui.item.data("sort-level");sortableItem(ui,level)},deactivate:function(event,ui){$("tr",elm).removeClass("ui-state-disabled")},update:function(event,ui){var level=ui.item.data("sort-level");sortnumber(level)},handle:".item-handle",items:"tr:not(.ui-state-disabled)"});$adminTable.find(".item-delete").click(function(){var $item=$(this).parents(".sort-item");deleteItem($item)});function addItem(){var $clone=$template.clone(),$list=$parentList.clone().val(""),count=$(elm).find("[data-sort-level=level-0-0]").length,all=$(elm).find(".sort-item").length,txt=$clone.html();$clone.html(txt.replace(/--seq--/g,all));$clone.find(".parent-select").replaceWith($list.get(0));var $sortSelect=$clone.find(".sort-select");for(var i=1;i<=count;i++){var $option=$("<option>").val(i).text(i);if(i===count){$option.prop("selected",true)}$sortSelect.append($option)}$clone.find(".item-delete").click(function(){deleteItem($clone)});$clone.addClass("sort-item").show();$anchor.before($clone);$adminTable.sortable("refresh")}function deleteItem($item){var msg=ACMS.Config.fieldgroupSortableItemDeleteMessage;if(!msg.length||confirm(msg)){$item.removeClass("sort-item").hide();$item.find("input:not(:checkbox)").val("");$adminTable.sortable("refresh")}}function sortableItem(ui,level){$("tr",elm).each(function(){if($(this).data("sort-level")===level){$(this).removeClass("ui-state-disabled")}else{$(this).addClass("ui-state-disabled")}});$adminTable.sortable({items:"tr:not(.ui-state-disabled)"});$adminTable.sortable("refresh")}function sortnumber(level){var number=1;var increment=true;if($entryOrder){if($entryOrder==="sort-asc"){increment=true}else if($entryOrder==="sort-desc"){increment=false}number=parseInt($firstSortNum)}$("tr",elm).each(function(){if($(this).data("sort-level")===level){var selctName=$(this).data("sort-name");$("[name^='"+selctName+"']",this).val(number);if(!$("[name^='"+selctName+"']",this).val()){var $option=$("<option>").val(number).text(number);$("[name^='"+selctName+"']",this).append($option).val(number)}$("[name^=checks]",this).attr("checked",true);if(increment)number++;else number--}});if($isException){$adminTable.sortable("cancel")}if($submitName){$("<input />").attr("type","hidden").attr("name",$submitName).attr("value","save").appendTo($targetForm);$targetForm.submit()}}};