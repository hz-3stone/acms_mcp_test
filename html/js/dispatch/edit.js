ACMS.Dispatch.Edit=function(context){var Edit=arguments.callee;var $unit=$(ACMS.Config.unitFormEditorMark,context);$unit.$target=$(".acms-admin-unit-add-btn",context);Edit._refresh($unit);ACMS.Dispatch.Utility.unloadAlert(context);$(ACMS.Config.unitFormEditorItemMark,$unit).each(function(){Edit._item(this,$unit)});Edit._add($unit);$("#tagListTrigger",context).each(function(){Edit.tagassist(this)}).show();$(ACMS.Config.editInplateTitleMark,context).each(function(){if(ACMS.Config.eid){Edit._editTitle(this)}});Edit.inplace(context);Edit._sortable($unit);try{if(["entry-edit","entry_editor"].includes(ACMS.Config.admin)&&ACMS.Config.webStorage==="on"&&typeof localStorage!="undefined"){ACMS.addListener("acmsDialogReady",()=>{Edit._saveform(context)})}}catch(e){}};ACMS.Dispatch.Edit._saveform=function(context){var $form=$("#entryForm",context),time=ACMS.Config.webStorageInterval,stop=false,bid=ACMS.Config.bid,cid=ACMS.Config.cid?ACMS.Config.cid:"0",eid=ACMS.Config.eid?ACMS.Config.eid:"0",data,storage;if(ACMS.Config.webStorageType==="session"){storage=sessionStorage}else if(ACMS.Config.webStorageType==="local"){storage=localStorage}var key="acms_bid-"+bid+"_cid-"+cid+"_eid-"+eid;data=storage.getItem(key);if(data!==null){var $module=$(":submit[name^=ACMS_POST]",$form).attr("name");data=JSON.parse(data);const dialogOptions={title:ACMS.i18n("edit.message5"),confirmButton:{label:ACMS.i18n("edit.message5")},cancelButton:{label:ACMS.i18n("edit.message6")},dialogProps:{size:"small",isCentered:true}};(async()=>{if(await ACMS.Library.dialog.confirm(ACMS.i18n("edit.message4"),dialogOptions)){recoverData()}else{saveWebStorage()}})()}else if(bid){saveWebStorage()}function saveWebStorage(){storage.removeItem(key);setTimeout(function(){$form.on("input",function(){var timer=setInterval(function(){if(storage){var $tmp=$form.clone(false);$form.find("select").each(function(i){$tmp.find("select").eq(i).val($(this).val())});$tmp.find("[type=file]").attr("type","hidden").val("acms-file");var serialize=$tmp.serializeArray();serialize=JSON.stringify(serialize);storage.setItem(key,serialize)}if(stop){clearInterval(timer);timer=null}},time);$form.off("input")})},500)}function recoverData(){storage.removeItem(key);stop=true;storage=null;var $form=$("<form/>",{action:"",method:"post",enctype:"multipart/form-data"});$.each(data,function(i,field){if(field.value.match(/acms-file/i)){$form.append($("<input/>",{type:"file",name:field.name}))}else if(field.name==="formToken"){$form.append($("<input/>",{type:"hidden",name:field.name,value:window.csrfToken}))}else{$form.append($("<input/>",{type:"hidden",name:field.name,value:field.value}))}});$form.append($("<input/>",{type:"hidden",name:$module,value:"save"}));$form.append($("<input/>",{type:"hidden",name:"recover_acms_Po9H2zdPW4fj",value:""}));$form.append($("<input/>",{type:"hidden",name:"field[]",value:"recover_acms_Po9H2zdPW4fj"}));$form.append($("<input/>",{type:"hidden",name:"recover_acms_Po9H2zdPW4fj"+":v#required"}));$form.appendTo(document.body);$form.trigger("submit")}};ACMS.Dispatch.Edit.tagassist=function(elm){$(elm).on("click",function(){ACMS.Dispatch.Edit._tagassist(this);return false})};ACMS.Dispatch.Edit._editTitle=function(elm){var $self=$(elm);$self.addClass("js-edit_inplace-title_trigger");$(".js-edit_inplace-title_trigger").on("click",function(event){event.preventDefault();const removeSplash=ACMS.Library.pending.splash(ACMS.i18n("splash.default"));var $detailBox=$("#js-edit_inplace-detail"),eid=ACMS.Config.eid;var $backdrop=$(".acms-admin-modal-backdrop");if(!$backdrop.length){$backdrop=$($.parseHTML('<div class="acms-admin-modal-backdrop"></div>')).hide().appendTo("body")}var code='            <div id="js-edit_inplace-detail" class="acms-admin-modal out">                <div class="acms-admin-modal-dialog large" role="dialog" aria-modal aria-labelledby="acms-admin-entry-title-edit-modal-title">                    <div class="acms-admin-modal-content">                        <header class="acms-admin-modal-header">                          <h1 id="acms-admin-entry-title-edit-modal-title" class="acms-admin-modal-heading">基本設定 / 詳細設定</h1>                          <button type="button" class="acms-admin-modal-hide" aria-label="基本設定 / 詳細設定を閉じる">                            <span class="acms-admin-icon-delete" aria-hidden="true"></span>                          </button>                        </header>                        <div class="acms-admin-modal-body">                        </div>                    </div>                </div>            </div>';if(!$detailBox.length){$detailBox=$($.parseHTML(code)).appendTo("body")}else{$detailBox.empty().remove();$detailBox=$($.parseHTML(code)).appendTo("body")}$.ajax({type:"GET",url:ACMS.Library.acmsLink({eid:eid,tpl:"admin/entry/edit.html",admin:"entry-edit",Query:{hash:Math.random().toString()}},true),dataType:"html",success:function(res){removeSplash();var action=ACMS.Library.acmsLink({eid:eid,admin:"entry-edit",Query:{hash:Math.random().toString()}},true),html=res.replace(/ACMS_POST_Entry_Update/,"ACMS_POST_Entry_Update_Detail"),$raw=$($.parseHTML(html)).attr("action",action);if($detailBox.length){$("body").css("overflow","hidden");$detailBox.find(".acms-admin-modal-body").append($raw);$detailBox.show();$backdrop.show();setTimeout(function(){$detailBox.removeClass("out").delay(200).queue(function(){$(this).addClass("in").delay(500).queue(function(){$(this).addClass("display").removeClass("in")}).dequeue()})},1)}var modalBody=$detailBox.find(".acms-admin-modal-body").get(0);ACMS.Dispatch($detailBox);ACMS.Dispatch.Edit($detailBox);ACMS.dispatchEvent("acmsDialogOpened",modalBody,{item:modalBody});var closeFn=function(){$("body").css("overflow","");$backdrop.fadeOut();$detailBox.removeClass("display").addClass("out");setTimeout(function(){$detailBox.hide()},500);return false};$('[name="ACMS_POST_Entry_Update_Detail"]',$detailBox).attr("disabled",false);$(".acms-admin-modal-hide").on("click",closeFn);$detailBox.on("click",function(event){var click=event.target;if($(click).hasClass("acms-admin-modal")){closeFn()}})}})})};ACMS.Dispatch.Edit._refresh=function($unit){$(':input[name="unit_sort[]"]',$unit).each(function(i){$(this).val(i+1)})};ACMS.Dispatch.Edit._remove=function(item,$unit){$(item).remove();ACMS.Dispatch.Edit._refresh($unit)};ACMS.Dispatch.Edit._sortable=function($unit){var Edit=this;var handle=".sorthandle";var browser=ACMS.Dispatch.Utility.browser();if(browser.mobile||browser.tablet){handle+=" .js-sp-sort-handle"}$unit.sortable({items:`${ACMS.Config.unitFormEditorItemMark}, .acms-admin-unit-add-btn`,handle:handle,cancel:"select",zIndex:999,opacity:.6,stop:function(){Edit._refresh($unit)}})};ACMS.Dispatch.Edit.inplace=function(context){$(".js-edit_inplace",context).each(function(){this.inplace=new ACMS.Dispatch.Edit._inplace(this)})};