jQuery.expr.filters.isFloatUnit=function(elem){return/(image|map|youtube|eximage|media)-(left|right)/.test(elem.className)};var inplaceFilterDie=null;ACMS.Dispatch.Edit._inplace=function(elm){this.self=elm;this.controll=false;var $self=$(this.self);$self.attr("tabindex",0);$self.off("mouseover focus");$self.on("mouseover focus",function(e){elm.inplace.hover()});$self.off("mouseout focusout");$self.on("mouseout focusout",function(){inplaceFilterDie=setTimeout(function(){if(!this.controll){elm.inplace.removeHover()}},800);return false});inplaceSortMode=false};ACMS.Dispatch.Edit._inplace.prototype={hover:function(){if(this.isLoading()){return false}else{this.removeHover()}if($(".js-edit_inplace-hovering").length){$(".js-edit_inplace-hovering").remove()}this.$hover=$($.parseHTML('<div class="js-edit_inplace-hovering" />'));this.overlay(this.$hover,$(this.self),$(this.self).parent());this.ctrlMenu()},removeHover:function(){clearTimeout(inplaceFilterDie);$(".js-edit_inplace-hovering").hide();$("#js-edit_inplace-control").hide()},removeHolder:function(){$("#js-edit_inplace-holder, #js-edit_inplace-units").hide()},ctrlMenu:function(){var $ctrl=$("#js-edit_inplace-control");if(!$ctrl.length){var dupli='<button id="js-edit_inplace-control-add_duplicate"><i class="acms-admin-icon-add-duplicate"></i><span class="js-edit_inplace-control-label">複製</span></button>',below='<button id="js-edit_inplace-control-add_below"><i class="acms-admin-icon-add-below"></i><span class="js-edit_inplace-control-label">追加</span></button>',edit='<button id="js-edit_inplace-control-edit"><i class="acms-admin-icon-control-edit"></i><span class="js-edit_inplace-control-label">編集</span></button>',del='<button id="js-edit_inplace-control-remove"><i class="acms-admin-icon-delete"></i><span class="js-edit_inplace-control-label">削除</span></button>',$ctrl=$($.parseHTML('<div id="js-edit_inplace-control">'+edit+below+dupli+del+"</div>")).appendTo("body");$ctrl.find("i").css({padding:"1px","font-size":"16px"});$ctrl.find(".js-edit_inplace-control-label").css({display:"block"});$ctrl.on("mouseover",function(){clearTimeout(inplaceFilterDie);this.controll=true});var own=this;$ctrl.on("mouseout",function(){inplaceFilterDie=setTimeout(own.removeHover,100);this.controll=false})}$ctrl.show().position({of:this.$hover,my:"left bottom",at:"left top",collision:"none"});$ctrl.css("z-index",2048);$("#js-edit_inplace-control-edit").off().on("click",{self:this.self},this.modify);$("#js-edit_inplace-control-remove").off().on("click",{self:this.self},this.remove);$("#js-edit_inplace-control-add_duplicate").off().on("click",{self:this.self},this.duplicate);$("#js-edit_inplace-control-add_below").off().on("click",{self:this.self},this.placeHold)},placeHold:function(event){var self=event.data.self;var $holder=$("#js-edit_inplace-holder");var $units=$("#js-edit_inplace-units");$.getJSON(ACMS.Library.acmsLink({tpl:"ajax/unit/inplace/menu.json",Query:{cache:(new Date).getTime().toString()}},true),function(menu){self.inplace.removeHover();self.inplace.removeHolder();if(!$holder.length){$holder=$($.parseHTML('<div id="js-edit_inplace-holder" />'))}if(!$units.length){$units=$($.parseHTML('<div id="js-edit_inplace-units" />')).appendTo($holder)}else{$units.empty()}menu.forEach(function(menuitem){const{type,label}=menuitem;$($.parseHTML('<button type="button">'+label+"</button>")).on("click",{self:self,type:type},self.inplace.add).appendTo($units)});$($.parseHTML('<button type="button" class="cansel">キャンセル</button>')).on("click",self.inplace.removeHolder).appendTo($units);$holder.hide().insertAfter(self);$holder.fadeIn("fast");$units.show()});return false},overlay:function($elm,$self,$parent){var pLeft=parseInt($parent.css("padding-left").replace(/px/,""));if($parent.css("position").match(/static/)){$parent.css("position","relative")}var $unit=$self.children().filter(":isFloatUnit");var $contain,$first,$last;if(!!$unit.length){$self=$unit;$contain=$self.parent().children().filter('[class!="clearHidden"]')}else{$contain=$self.children().filter('[class!="clearHidden"]')}$first=$contain.first();$last=$contain.last();if(!$first.length)$first=$self;if(!$last.length)$last=$self;var margin={top:parseInt($first.css("margin-top").replace(/px/,"")),bottom:parseInt($last.css("margin-bottom").replace(/px/,"")),left:parseInt($first.css("margin-left").replace(/px/,"")),right:parseInt($first.css("margin-right").replace(/px/,""))};var pos=$self.position();pos.top=$first.position().top+margin.top;pos.bottom=$last.position().top+$last.outerHeight(true);var $prev=$self.prev().children().filter(":isFloatUnit");var $prevUnit=$self.prev();var realityPosition=$first.offset().top;var clearAttr=$first.css("clear");$first.css({clear:"both"});var clearPosition=$first.offset().top;$first.css({clear:clearAttr});if(realityPosition!==clearPosition){var $temp=false;var $current=$self;var i=0;do{i++;$temp=$current.prev().children().filter(":isFloatUnit");$current=$current.prev()}while(!$temp.length&&i<99);$prev=$temp}var width=$self.innerWidth(),height;if($contain.length==1){height=$last.innerHeight()}else{height=pos.bottom-pos.top}if(height<35){height=35}var $isSteppedDown=false;if(!!$prev.length){var sPos=$prev.position(),sHeight=$prev.innerHeight(),sWidth=$prev.innerWidth(),pPos=$prevUnit.position(),pHeight=$prevUnit.innerHeight();sPos.bottom=sPos.top+sHeight;sPos.left=sPos.left-pLeft;pPos.bottom=pPos.top+pHeight;if(sPos.bottom>=pos.top){var belowWidth;if($prev.get(0)&&$prev.get(0).className.match(/(image|map|youtube|eximage|file)-left/)){belowWidth=sPos.left+sWidth;width=width-(sPos.left+sWidth);pos.left=sPos.left+sWidth+pLeft}else{belowWidth=sWidth;width=width-sWidth}if(sPos.bottom<=pos.bottom&&width*height<belowWidth*(pos.bottom-sPos.bottom)){$isSteppedDown=true;$elm.css({width:width-4,height:pos.bottom-pPos.bottom,position:"absolute",left:pos.left,top:pPos.bottom,zIndex:2048}).appendTo($parent);return}}}if($first.get(0)&&$first.get(0).className.match(/(image|map|youtube|eximage|file)-center/)){margin.left=0;width=$self.innerWidth()}if(!$isSteppedDown){$elm.css({width:width-4,height:height,position:"absolute",left:pos.left,top:pos.top,zIndex:2048}).prependTo($parent)}},close:function(){$("#js-edit_inplace-box").hide();$("#js-edit_inplace-title").hide()},isLoading:function(){return!!$(".js-edit_inplace-loading").length},isHovering:function(){return!!$(".js-edit_inplace-hovering").length},add:function(event){var self=event.data.self,type=event.data.type,$self=$(self),$parent=$self.parent();if(self.inplace.isLoading()){return false}self.inplace.removeHover();self.inplace.close();var $loader=$('<div class="js-edit_inplace-loading" />');self.inplace.overlay($loader,$self,$parent);var $spinner=$(`
      <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
        <div class="acms-admin-spinner"></div>
      </div>
    `);$loader.append($spinner);var eid=$(self).attr("data-unit-entry-id");var utid=$(self).attr("data-unit-id");if(!eid||!utid){return false}var url=ACMS.Library.acmsLink({eid:eid,utid:utid,tpl:"ajax/unit/inplace/insert.html",admin:"entry-update-unit-"+type,Query:{hash:Math.random().toString()}},true);self.inplace.dialog(self,url)},modify:function(event){var self=event.data.self,$parent=$(self).parent();if(self.inplace.isLoading()){return false}self.inplace.removeHover();self.inplace.removeHolder();self.inplace.close();var $loader=$('<div class="js-edit_inplace-loading" />');self.inplace.overlay($loader,$(self),$parent);var $spinner=$(`
      <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
        <div class="acms-admin-spinner"></div>
      </div>
    `);$loader.append($spinner);var eid=$(self).attr("data-unit-entry-id");var utid=$(self).attr("data-unit-id");if(!eid||!utid){return false}var url=ACMS.Library.acmsLink({eid:eid,utid:utid,tpl:"ajax/unit/inplace/update.html",admin:"entry-update-unit",Query:{hash:Math.random().toString()}},true);self.inplace.dialog(self,url)},submit:async function(event){event.preventDefault();const self=event.data.self;const formData=new FormData(this,event.originalEvent.submitter);const intent=formData.get("intent");if(intent==="cancel"){self.inplace.close()}else if(intent==="save"){try{$('[type="submit"]',this).attr("disabled",true);await self.inplace.save(this.action,formData,self)}catch(error){console.error("Inplace edit error:",error);ACMS.Library.notify.danger(error.message)}finally{$('[type="submit"]',this).attr("disabled",false)}}return false},save:async function(action,formData,self){if(formData.has("unit_sort[]")){const sort=formData.get("unit_sort[]");formData.set("unit_sort[]",`${parseInt(sort,10)+1}`)}const response=await fetch(action,{method:"POST",body:formData,headers:{"X-Requested-With":"XMLHttpRequest","X-Csrf-Token":window.csrfToken||""}});if(!response.ok){throw new Error(`HTTP error! status: ${response.status}`)}const html=await response.text();if(html===""){throw new Error(ACMS.i18n("direct_edit.message1"))}const unitId=formData.get("unit_id[]");const parser=new DOMParser;const doc=parser.parseFromString(html,"text/html");const $content=$(`.js-edit_inplace[data-unit-id="${unitId}"]`,doc.body);const $container=$(`.js-edit_inplace[data-unit-id="${unitId}"]`);if($container.length===0){$content.filter("*").insertAfter($("#js-edit_inplace-holder")).fadeTo(250,.1).fadeTo(300,1);self.inplace.removeHolder();ACMS.Dispatch.Edit.inplace($content.parent());ACMS.Dispatch($content)}else{const{attributes}=$content.get(0);for(const attribute of attributes){$container.attr(attribute.name,attribute.value)}$container.fadeTo(250,.1).html($content.html()).fadeTo(450,$content.css("opacity"));ACMS.Dispatch($container)}if(ACMS.Config.unitAlignVersion==="v1"){self.inplace.adjustAlign()}self.inplace.close()},dialog:function(self,url){var $editinBox=$("#js-edit_inplace-box"),$html={};if(!$editinBox.length){$editinBox=$($.parseHTML('<div id="js-edit_inplace-box" />')).appendTo("body")}$.ajax({type:"GET",url:url,dataType:"html",error:function(xhr){$editinBox.empty().append($(xhr.responseText)).css("background-color","white");$(".js-edit_inplace-loading").remove();$editinBox.fadeIn("fast").position({of:window,my:"center center"}).draggable({handle:".acms-admin-unit-toolbar",opacity:.8,scroll:true,distance:5})},success:function(html){$html=$($.parseHTML(html));$('[for^="input-checkbox-file_edit_"]',$html).remove();$editinBox.empty().append($html);$(".js-edit_inplace-loading").remove();$editinBox.fadeIn("fast").position({of:window,my:"center top",at:"center top+16"}).draggable({handle:".acms-admin-unit-toolbar",opacity:.8,scroll:true,distance:5});ACMS.dispatchEvent("acmsInplaceDialogOpen",$editinBox.get(0));$("#unitForm",$editinBox).off().on("submit",{self:self},self.inplace.submit)}})},remove:async function(event){var self=event.data.self;if(await ACMS.Library.dialog.confirm(ACMS.i18n("direct_edit.message2"),{confirmButton:{className:"acms-admin-btn-danger"}})){self.inplace.voidPost(self,{ACMS_POST_Unit_Remove:true,formToken:window.csrfToken},function(){var $self=$(self);$self.off("mouseover");self.inplace.removeHover();$self.remove()})}else{return false}},duplicate:function(event){const self=event.data.self;self.inplace.duplicatePost(self,function(res){const $self=$(self);const unitId=$self.attr("data-unit-id");const parser=new DOMParser;const doc=parser.parseFromString(res,"text/html");const $content=$(`.js-edit_inplace[data-unit-id="${unitId}"]`,doc.body).next();$content.insertAfter($self);ACMS.Dispatch.Edit.inplace($content.parent());ACMS.Dispatch($content);$content.fadeTo(250,.1).fadeTo(450,1);if(ACMS.Config.unitAlignVersion==="v1"){self.inplace.adjustAlign()}})},duplicatePost:function(self,callback){var eid=$(self).attr("data-unit-entry-id");var utid=$(self).attr("data-unit-id");if(!eid||!utid){return false}var url=ACMS.Library.acmsLink({eid:eid,utid:utid,Query:{hash:Math.random().toString()}},true);$.ajax({url:url,type:"post",dataType:"html",data:{ACMS_POST_Unit_Duplicate:true,formToken:window.csrfToken},success:callback})},voidPost:function(self,data,callback){var eid=$(self).attr("data-unit-entry-id");var utid=$(self).attr("data-unit-id");if(!eid||!utid){return false}var url=ACMS.Library.acmsLink({eid:eid,utid:utid,Query:{hash:Math.random().toString()}},true);$.ajax({url:url,type:"post",dataType:"html",data:data,success:callback})},adjustAlign:function(){if(ACMS.Config.unitAlignVersion!=="v1"){return}$(".js-edit_inplace").each(function(){var $unit=$(this);if(!!$unit.length){$unit.get(0).className.match(/(left|center|right|auto)/);var self_align=RegExp.$1}if(!!$unit.prev().length){$unit.prev().get(0).className.match(/(left|center|right|auto)/);var prev_align=RegExp.$1}$unit.children().filter("hr.clearHidden").remove();do{if(typeof prev_align=="undefined"){break}if("left"==self_align&&"left"==prev_align){break}if("rigth"==self_align&&"right"==prev_align){break}if("auto"==self_align){if("left"==prev_align){break}if("right"==prev_align){break}if("auto"==prev_align){break}}$unit.prepend('<hr class="clearHidden" />')}while(false)})}};