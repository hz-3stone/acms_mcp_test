<tr>
    <th>カラム数
        <i class="acms-admin-icon-tooltip js-acms-tooltip" data-acms-tooltip="カラム数を変更するとモジュール設定内の「表示設定」>「ループ親クラス」にカラム設定用のクラスが入ります。"></i>
    </th>
    <td>
        <div class="acms-acmin-grid">
            <div class="acms-admin-col-md-3">
                <label for="col-base" class="acms-admin-margin-bottom-mini">ベースカラム数</label>
                <select id="col-base" name="col-base" class="acms-admin-form-width-full">
                    <option value="" {col-base:selected#}>未設定</option>
                    <option value="acms-g-cols-1" {col-base:selected#acms-g-cols-1}>1カラム</option>
                    <option value="acms-g-cols-2" {col-base:selected#acms-g-cols-2}>2カラム</option>
                    <option value="acms-g-cols-3" {col-base:selected#acms-g-cols-3}>3カラム</option>
                    <option value="acms-g-cols-4" {col-base:selected#acms-g-cols-4}>4カラム</option>
                </select>
            </div>
            <div class="acms-admin-col-md-3">
                <label for="col-sm" class="acms-admin-margin-bottom-mini">480px以上</label>
                <input type="hidden" name="field[]" value="col-base" />
                <select id="col-sm" name="col-sm" class="acms-admin-form-width-full">
                    <option value="" {col-sm:selected#}>未設定</option>
                    <option value="acms-g-cols-sm-1" {col-sm:selected#acms-g-cols-sm-1}>1カラム</option>
                    <option value="acms-g-cols-sm-2" {col-sm:selected#acms-g-cols-sm-2}>2カラム</option>
                    <option value="acms-g-cols-sm-3" {col-sm:selected#acms-g-cols-sm-3}>3カラム</option>
                    <option value="acms-g-cols-sm-4" {col-sm:selected#acms-g-cols-sm-4}>4カラム</option>
                </select>

                <input type="hidden" name="field[]" value="col-sm" />
            </div>
            <div class="acms-admin-col-md-3">
                <label for="col-md" class="acms-admin-margin-bottom-mini">768px以上</label>

                <select name="col-md" class="acms-admin-form-width-full">
                    <option value="" {col-md:selected#}>未設定</option>
                    <option value="acms-g-cols-md-1" {col-md:selected#acms-g-cols-md-1}>1カラム</option>
                    <option value="acms-g-cols-md-2" {col-md:selected#acms-g-cols-md-2}>2カラム</option>
                    <option value="acms-g-cols-md-3" {col-md:selected#acms-g-cols-md-3}>3カラム</option>
                    <option value="acms-g-cols-md-4" {col-md:selected#acms-g-cols-md-4}>4カラム</option>
                </select>
                <input type="hidden" name="field[]" value="col-md" />
            </div>
            <div class="acms-admin-col-md-3">
                <label for="col-lg" class="acms-admin-margin-bottom-mini">1024px以上</label>
                <select id="col-lg" name="col-lg" class="acms-admin-form-width-full">
                    <option value="" {col-lg:selected#}>未設定</option>
                    <option value="acms-g-cols-lg-1" {col-lg:selected#acms-g-cols-lg-1}>1カラム</option>
                    <option value="acms-g-cols-lg-2" {col-lg:selected#acms-g-cols-lg-2}>2カラム</option>
                    <option value="acms-g-cols-lg-3" {col-lg:selected#acms-g-cols-lg-3}>3カラム</option>
                    <option value="acms-g-cols-lg-4" {col-lg:selected#acms-g-cols-lg-4}>4カラム</option>
                </select>
                <input type="hidden" name="field[]" value="col-lg" />

                <span id="col-etc"></span>
            </div>
        </div>
        <script>
            ACMS.addListener("acmsReady", function () {
                // document.addEventListener("DOMContentLoaded", function () {

                const loopClass = document.querySelector('input[name="{{target_input}}"]');

                const colBase = document.querySelector('select[name="col-base"]');
                const colSm = document.querySelector('select[name="col-sm"]');
                const colMd = document.querySelector('select[name="col-md"]');
                const colLg = document.querySelector('select[name="col-lg"]');
                const colEtc = document.getElementById("col-etc");

                function updateLoopClass() {
                    const values = [colBase.value, colSm.value, colMd.value, colLg.value].filter(value => value !== "");
                    loopClass.value = values.join(" ");
                }

                function ensureOptionExists(select, value) {
                    if (!value || select.querySelector(`option[value="${value}"]`)) return;
                    const existingValues = new Set(Array.from(select.options).map(opt => opt.value));
                    if (!existingValues.has(value)) {
                        const option = document.createElement("option");
                        option.value = value;
                        option.textContent = value;
                        option.setAttribute("data-custom", "true");
                        select.appendChild(option);
                    }
                }

                function updateSelectValues() {
                    const values = loopClass.value.split(" ").map(val => val.trim()).filter(val => val !== "");
                    let baseValue = "", smValue = "", mdValue = "", lgValue = "";
                    let extraValues = [];

                    values.forEach(val => {
                        if (/^acms-g-cols-sm-\d+$/.test(val)) {
                            smValue = val;
                        } else if (/^acms-g-cols-md-\d+$/.test(val)) {
                            mdValue = val;
                        } else if (/^acms-g-cols-lg-\d+$/.test(val)) {
                            lgValue = val;
                        } else if (/^acms-g-cols-\d+$/.test(val)) {
                            baseValue = val;
                        } else {
                            extraValues.push(val);
                        }
                    });

                    ensureOptionExists(colBase, baseValue);
                    ensureOptionExists(colSm, smValue);
                    ensureOptionExists(colMd, mdValue);
                    ensureOptionExists(colLg, lgValue);

                    colBase.value = baseValue;
                    colSm.value = smValue;
                    colMd.value = mdValue;
                    colLg.value = lgValue;

                    colEtc.textContent = extraValues.length > 0 ? extraValues.join(", ") : "";
                }

                colBase.addEventListener("change", updateLoopClass);
                colSm.addEventListener("change", updateLoopClass);
                colMd.addEventListener("change", updateLoopClass);
                colLg.addEventListener("change", updateLoopClass);

                loopClass.addEventListener("input", updateSelectValues);

                updateSelectValues();
                // });
            });
        </script>
    </td>
</tr>
